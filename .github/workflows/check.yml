name: Checks

on:
  - push
  - pull_request

jobs:
  detect-quota:
    # Probe the hosted runner (same flavor as the original try job) so we
    # can decide whether to use a hosted runner or fall back to
    # self-hosted. The job should fail if quota is exhausted.
    runs-on: ubuntu-latest
    steps:
      - name: Quota probe
        id: quota_probe
        run: |
          echo "probe"

  eslint:
    # ESLint job inlined from check-shared-steps.yml
    needs: detect-quota
    if: ${{ always() }}
    runs-on: ${{ needs.detect-quota.result == 'success' && 'ubuntu-latest' || 'self-hosted' }}
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: |
          corepack enable
          corepack install

      - uses: actions/setup-node@v4
        with:
          cache: yarn

      - run: |
          yarn install

      - run: |
          yarn run lint

  commitlint:
    # Commitlint job inlined from check-shared-steps.yml
    needs: detect-quota
    if: ${{ always() }}
    runs-on: ${{ needs.detect-quota.result == 'success' && 'ubuntu-latest' || 'self-hosted' }}
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: wagoid/commitlint-github-action@v6

  tests:
    # Tests job inlined from check-shared-steps.yml
    needs: detect-quota
    if: ${{ always() }}
    runs-on: ${{ needs.detect-quota.result == 'success' && 'ubuntu-latest' || 'self-hosted' }}
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - uses: supercharge/mongodb-github-action@1.11.0
        with:
          mongodb-version: 7

      - run: |
          corepack enable
          corepack install

      - uses: actions/setup-node@v4
        with:
          cache: yarn

      - run: |
          yarn install

      - run: |
          yarn run test
