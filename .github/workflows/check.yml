name: Checks

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

# Use concurrency to deduplicate runs.
# - For pull requests: group by `pr-<number>` so multiple commits to the same PR
#   cancel previous runs and only the latest is kept.
# - For direct pushes: fall back to deduplicating by commit SHA so identical
#   commits don't trigger multiple concurrent workflows.
# - Include the `github.workflow` name in the group to avoid cross-workflow collisions.
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || github.sha }}
  cancel-in-progress: true

# Minimal file-level permissions for checks: read repository contents for linting/tests
permissions:
  contents: read
  pull-requests: read

jobs:
  detect-quota:
    # Probe the hosted runner (same flavor as the original try job) so we
    # can decide whether to use a hosted runner or fall back to
    # self-hosted. The job should fail if quota is exhausted.
    permissions: {}
    runs-on: ubuntu-slim
    timeout-minutes: 1
    steps:
      - name: Quota probe
        id: quota_probe
        run: |
          echo "probe"

  # NOTE: Do not set `continue-on-error: true` on the `detect-quota` job.
  # If `continue-on-error` is enabled the job result will always be
  # 'success', which defeats detection (we rely on `needs.detect-quota.result`).
  # Unfortunately this means the workflow may be reported as failed if the
  # hosted runner is unavailable. We cannot work around this until GitHub
  # provides a job-level "allow-failure"/neutral-conclusion feature
  # (see: https://github.com/actions/runner/issues/2347 for discussion).

  lint-fmt:
    # ESLint job inlined from check-shared-steps.yml
    needs: detect-quota
    if: ${{ always() }}
    runs-on: ${{ needs.detect-quota.result == 'success' && 'ubuntu-slim' || 'self-hosted' }}
    timeout-minutes: 5
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: |
          corepack enable
          corepack install

      - uses: actions/setup-node@v4
        with:
          cache: yarn

      - run: |
          yarn install

      - run: |
          yarn lint:check
          yarn fmt:check

  commitlint:
    # Commitlint job inlined from check-shared-steps.yml
    needs: detect-quota
    if: ${{ always() }}
    runs-on: ${{ needs.detect-quota.result == 'success' && 'ubuntu-latest' || 'self-hosted' }}
    timeout-minutes: 2
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        if: (github.ref == 'refs/heads/main' || github.base_ref == 'main')

      - uses: wagoid/commitlint-github-action@v6
        if: (github.ref == 'refs/heads/main' || github.base_ref == 'main')

  tests:
    # Tests job inlined from check-shared-steps.yml
    needs: detect-quota
    if: ${{ always() }}
    runs-on: ${{ needs.detect-quota.result == 'success' && 'ubuntu-latest' || 'self-hosted' }}
    timeout-minutes: 5
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - uses: supercharge/mongodb-github-action@1.12.1
        with:
          mongodb-version: 7

      - run: |
          corepack enable
          corepack install

      - uses: actions/setup-node@v4
        with:
          cache: yarn

      - run: |
          yarn install

      - run: |
          yarn run test
