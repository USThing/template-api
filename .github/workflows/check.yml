name: Checks

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

# Use concurrency to deduplicate runs.
# - For pull requests: group by `pr-<number>` so multiple commits to the same PR
#   cancel previous runs and only the latest is kept.
# - For direct pushes: fall back to deduplicating by commit SHA so identical
#   commits don't trigger multiple concurrent workflows.
# - Include the `github.workflow` name in the group to avoid cross-workflow collisions.
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || github.sha }}
  cancel-in-progress: true

# Minimal file-level permissions for checks: read repository contents for linting/tests
permissions:
  contents: read
  pull-requests: read

jobs:
  # `vars.ACTIONS_RUNNER_TYPE` is set on private repositories only.

  lint-fmt:
    runs-on: ${{ vars.ACTIONS_RUNNER_TYPE || 'ubuntu-latest' }}
    timeout-minutes: 5
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v6
        with:
          node-version: 24

      - run: |
          corepack enable
          corepack install

      - uses: actions/setup-node@v6
        with:
          cache: yarn

      - run: |
          yarn install

      - run: |
          yarn lint:check
          yarn fmt:check

  commitlint:
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ${{ vars.ACTIONS_RUNNER_TYPE || 'ubuntu-latest' }}
    timeout-minutes: 2
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - uses: wagoid/commitlint-github-action@v6

  tests:
    runs-on: ${{ vars.ACTIONS_RUNNER_TYPE || 'ubuntu-latest' }}
    timeout-minutes: 5
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 24

      - run: |
          corepack enable
          corepack install

      - uses: actions/setup-node@v6
        with:
          cache: yarn

      - run: |
          yarn install

      - run: |
          yarn run test
